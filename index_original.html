<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Survey System - Anonymous Corporate Research Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .wallet-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .btn {
            background: linear-gradient(45deg, #10b981, #34d399);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            margin: 10px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-loading {
            color: transparent !important;
            pointer-events: none;
        }

        .btn-loading::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .status {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 20px;
            margin: 10px;
            font-weight: bold;
        }

        .disconnected { 
            background: #6c757d; 
            color: white; 
        }

        .connected { 
            background: #28a745; 
            color: white; 
            animation: pulse 2s infinite;
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid transparent;
            padding: 12px 24px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section.hidden {
            display: none;
        }

        .section h2 {
            font-size: 2rem;
            margin-bottom: 25px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .form-control:focus {
            outline: none;
            border-color: white;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .project-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .project-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .project-description {
            opacity: 0.9;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(45deg, #10b981, #34d399);
            height: 100%;
            transition: width 0.5s;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        .project-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .donation-form {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            align-items: center;
        }

        .donation-input {
            flex: 1;
        }

        .quick-amounts {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .quick-amount {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .quick-amount:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .alerts {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 350px;
            max-width: 90vw;
        }

        .alert {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-weight: bold;
            animation: slideIn 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .alert-success { border-left: 4px solid #10b981; }
        .alert-error { border-left: 4px solid #ef4444; }
        .alert-warning { border-left: 4px solid #f59e0b; }
        .alert-info { border-left: 4px solid #3b82f6; }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .owner-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            padding: 10px 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .completed-badge {
            background: linear-gradient(45deg, #10b981, #34d399);
            padding: 10px 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
        }

        /* Animations */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Rating buttons */
        .rating-btn {
            transition: all 0.3s !important;
        }
        
        input[type="radio"]:checked + .rating-btn {
            background: linear-gradient(45deg, #10b981, #34d399) !important;
            border-color: #34d399 !important;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }
        
        .rating-btn:hover {
            background: rgba(255,255,255,0.2) !important;
            transform: translateY(-1px);
            cursor: pointer;
        }
        
        .rating-btn:active {
            transform: translateY(0px);
        }
        
        .survey-section {
            border: 2px solid rgba(255,255,255,0.1);
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .survey-section:hover {
            border-color: rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.02);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .donation-form { flex-direction: column; }
            .nav { flex-direction: column; align-items: center; }
            .container { padding: 15px; }
            .section { padding: 20px; }
            .project-stats { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Employee Satisfaction Survey</h1>
            <p>Anonymous Corporate Survey System - Privacy-Protected Research Platform</p>
            <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px;">
                Contract: <a href="https://sepolia.etherscan.io/address/0x32db9e03494b45a0b2b2B85Cfb767CD65B49275A" 
                target="_blank" style="color: #34d399; text-decoration: none;">
                0x9Fdc...1F31</a> | Sepolia Testnet
            </p>
            <div id="contract-status" style="font-size: 0.85rem; margin-top: 10px; padding: 8px 15px; border-radius: 20px; display: inline-block; background: rgba(255,255,255,0.1);">
                üîç Checking contract status...
            </div>
        </div>

        <div class="wallet-section">
            <div id="wallet-status" class="status disconnected">Wallet Disconnected</div>
            <div id="wallet-details" style="display: none;">
                <div id="wallet-address" style="margin: 10px; font-family: monospace;"></div>
                <div id="wallet-balance" style="margin: 10px; font-size: 1.1rem;">Balance: 0.0000 ETH</div>
            </div>
            <button id="connect-btn" class="btn" onclick="connectWallet()">üîó Connect Wallet</button>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="showSection('surveys')">üìã Surveys</button>
            <button class="nav-btn" onclick="showSection('create')">‚ûï Create Survey</button>
        </div>

        <div id="surveys-section" class="section">
            <h2>üìã Employee Satisfaction Surveys</h2>
            <div id="surveys-list"></div>
            <div id="no-surveys" class="empty-state">
                <h3>üå± No Surveys Available</h3>
                <p>Create your first employee satisfaction survey!</p>
                <button class="btn" onclick="showSection('create')">‚ûï Create First Survey</button>
            </div>
        </div>

        <div id="create-section" class="section hidden">
            <h2>‚ú® Create Employee Satisfaction Survey</h2>
            <form id="create-form" onsubmit="createSurvey(event)">
                <div class="form-group">
                    <label class="form-label">üìù Survey Title</label>
                    <input type="text" id="survey-title" class="form-control" placeholder="Enter survey title..." required maxlength="100">
                </div>
                <div class="form-group">
                    <label class="form-label">üìÑ Survey Description</label>
                    <textarea id="survey-description" class="form-control" rows="4" placeholder="Describe the purpose and content of this survey..." required maxlength="500"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">‚è∞ Survey Duration (Days)</label>
                    <input type="number" id="survey-duration" class="form-control" min="1" max="30" value="14" placeholder="Set survey duration (1-30 days)" required>
                </div>
                <div class="form-group">
                    <label class="form-label">üìã Survey Questions</label>
                    <div id="survey-questions">
                        <input type="text" class="form-control" placeholder="Question 1" value="How satisfied are you with the overall work environment?" style="margin-bottom: 10px;">
                        <input type="text" class="form-control" placeholder="Question 2" value="How satisfied are you with your direct supervisor's management style?" style="margin-bottom: 10px;">
                        <input type="text" class="form-control" placeholder="Question 3" value="How satisfied are you with the compensation and benefits?" style="margin-bottom: 10px;">
                        <input type="text" class="form-control" placeholder="Question 4" value="How satisfied are you with career development opportunities?" style="margin-bottom: 10px;">
                        <input type="text" class="form-control" placeholder="Question 5" value="How satisfied are you with team collaboration atmosphere?" style="margin-bottom: 10px;">
                    </div>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px;">
                        üí° Rating Scale: 1-5 (1=Very Dissatisfied, 2=Dissatisfied, 3=Neutral, 4=Satisfied, 5=Very Satisfied)
                    </p>
                </div>
                <button type="submit" class="btn" style="font-size: 1.1rem; padding: 15px 30px;">üìã Create Survey</button>
            </form>
        </div>
    </div>

    <div id="alerts" class="alerts"></div>

    <script>
        let account = null;
        let balance = '0.0000';
        let surveys = JSON.parse(localStorage.getItem('employeeSurvey_surveys') || '[]');
        let surveyStates = new Map(); // ÂÖ≥ÈîÆÔºöÈò≤Ê≠¢ÊåâÈíÆÂç°Ê≠ª
        let surveyTimeouts = new Map(); // Ë∂ÖÊó∂ÁÆ°ÁêÜ
        let userResponses = JSON.parse(localStorage.getItem('employeeSurvey_responses') || '{}');
        
        // ÂêàÁ∫¶ÈÖçÁΩÆ - Sepolia ÊµãËØïÁΩë
        const CONTRACT_ADDRESS = '0x32db9e03494b45a0b2b2B85Cfb767CD65B49275A';
        const SEPOLIA_CHAIN_ID = '0xaa36a7'; // 11155111 in hex
        const SEPOLIA_RPC = 'https://sepolia.infura.io/v3/';
        
        // ÂêàÁ∫¶ABI - Employee Survey FHE Contract (Zama FHEVM)
        const CONTRACT_ABI = [
            {
                "inputs": [{"internalType": "string", "name": "_title", "type": "string"}, 
                          {"internalType": "string", "name": "_description", "type": "string"}, 
                          {"internalType": "string[]", "name": "_questions", "type": "string[]"}, 
                          {"internalType": "uint256", "name": "_durationDays", "type": "uint256"}],
                "name": "createSurvey",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}, 
                          {"internalType": "uint8[]", "name": "_ratings", "type": "uint8[]"}],
                "name": "submitResponse",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}],
                "name": "getSurvey",
                "outputs": [{"internalType": "address", "name": "creator", "type": "address"}, 
                           {"internalType": "string", "name": "title", "type": "string"}, 
                           {"internalType": "string", "name": "description", "type": "string"}, 
                           {"internalType": "uint256", "name": "startTime", "type": "uint256"}, 
                           {"internalType": "uint256", "name": "endTime", "type": "uint256"}, 
                           {"internalType": "bool", "name": "active", "type": "bool"}, 
                           {"internalType": "bool", "name": "resultsPublished", "type": "bool"}, 
                           {"internalType": "uint256", "name": "totalResponses", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}],
                "name": "getSurveyQuestions",
                "outputs": [{"internalType": "string[]", "name": "", "type": "string[]"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getTotalSurveys",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}, 
                          {"internalType": "address", "name": "_employee", "type": "address"}],
                "name": "hasResponded",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}],
                "name": "closeSurvey",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}],
                "name": "publishResults",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}, 
                          {"internalType": "uint256", "name": "_questionId", "type": "uint256"}],
                "name": "requestQuestionResult",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}],
                "name": "getCurrentSurveyInfo",
                "outputs": [{"internalType": "bool", "name": "active", "type": "bool"}, 
                           {"internalType": "bool", "name": "resultsPublished", "type": "bool"}, 
                           {"internalType": "uint256", "name": "totalResponses", "type": "uint256"}, 
                           {"internalType": "uint256", "name": "questionsCount", "type": "uint256"}, 
                           {"internalType": "uint256", "name": "timeRemaining", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_surveyId", "type": "uint256"}, 
                          {"internalType": "address", "name": "_employee", "type": "address"}],
                "name": "getEmployeeResponseStatus",
                "outputs": [{"internalType": "bool", "name": "hasResponded", "type": "bool"}, 
                           {"internalType": "uint256", "name": "responseTime", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [{"indexed": true, "internalType": "uint256", "name": "surveyId", "type": "uint256"}, 
                          {"indexed": true, "internalType": "address", "name": "creator", "type": "address"}, 
                          {"indexed": false, "internalType": "string", "name": "title", "type": "string"}, 
                          {"indexed": false, "internalType": "uint256", "name": "endTime", "type": "uint256"}],
                "name": "SurveyCreated",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [{"indexed": true, "internalType": "uint256", "name": "surveyId", "type": "uint256"}, 
                          {"indexed": true, "internalType": "address", "name": "respondent", "type": "address"}, 
                          {"indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256"}],
                "name": "ResponseSubmitted",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [{"indexed": true, "internalType": "uint256", "name": "surveyId", "type": "uint256"}, 
                          {"indexed": false, "internalType": "uint256", "name": "totalResponses", "type": "uint256"}],
                "name": "ResultsPublished",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [{"indexed": true, "internalType": "uint256", "name": "surveyId", "type": "uint256"}, 
                          {"indexed": true, "internalType": "uint256", "name": "questionId", "type": "uint256"}, 
                          {"indexed": false, "internalType": "uint8", "name": "averageRating", "type": "uint8"}],
                "name": "ResultsRevealed",
                "type": "event"
            }
        ];
        
        let web3 = null;
        let contract = null;

        // Â±èËîΩÂ∏∏ËßÅÁöÑÊµèËßàÂô®Êâ©Â±ïË≠¶Âëä
        window.addEventListener('error', (e) => {
            if (e.message && e.message.includes('runtime.lastError')) {
                e.preventDefault();
                return false;
            }
        });

        // Â±èËîΩÊéßÂà∂Âè∞‰∏≠ÁöÑÊâ©Â±ïÁõ∏ÂÖ≥Ë≠¶Âëä
        const originalConsoleError = console.error;
        console.error = function(...args) {
            const message = args.join(' ');
            if (message.includes('runtime.lastError') || 
                message.includes('devtools') ||
                message.includes('Extension context invalidated')) {
                return; // ÈùôÈªòËøô‰∫õË≠¶Âëä
            }
            originalConsoleError.apply(console, args);
        };

        // È¢ÑËÆæË∞ÉÊü•Êï∞ÊçÆ
        function initializePresetSurveys() {
            if (surveys.length === 0) {
                const presetSurveys = [
                    {
                        id: 1,
                        title: "Q1 2025 Employee Satisfaction Survey",
                        description: "Quarterly assessment of employee satisfaction across all departments focusing on work environment, management, and career development opportunities.",
                        questions: [
                            "How satisfied are you with the overall work environment?",
                            "How satisfied are you with your direct supervisor's management style?",
                            "How satisfied are you with the compensation and benefits package?",
                            "How satisfied are you with career development opportunities?",
                            "How satisfied are you with work-life balance?"
                        ],
                        creator: "0x1234567890123456789012345678901234567890", // HR Admin address
                        createdAt: new Date('2025-01-15'),
                        endTime: new Date('2026-12-31'),
                        responses: [
                            { question: "How satisfied are you with the overall work environment?", ratings: [2,5,15,25,8], totalResponses: 55, averageRating: 3.7 },
                            { question: "How satisfied are you with your direct supervisor's management style?", ratings: [3,4,12,28,8], totalResponses: 55, averageRating: 3.8 },
                            { question: "How satisfied are you with the compensation and benefits package?", ratings: [8,12,20,12,3], totalResponses: 55, averageRating: 2.9 },
                            { question: "How satisfied are you with career development opportunities?", ratings: [5,8,18,18,6], totalResponses: 55, averageRating: 3.4 },
                            { question: "How satisfied are you with work-life balance?", ratings: [1,3,10,30,11], totalResponses: 55, averageRating: 4.0 }
                        ],
                        totalResponses: 55,
                        status: 'active'
                    },
                    {
                        id: 2,
                        title: "Remote Work Experience Survey",
                        description: "Evaluate employee experience with remote work policies, tools, and collaboration effectiveness in distributed teams.",
                        questions: [
                            "How satisfied are you with remote work tools and technology?",
                            "How satisfied are you with communication and collaboration remotely?",
                            "How satisfied are you with remote work productivity levels?",
                            "How satisfied are you with manager support during remote work?"
                        ],
                        creator: "0x1234567890123456789012345678901234567890", // HR Admin address
                        createdAt: new Date('2025-02-01'),
                        endTime: new Date('2026-12-31'),
                        responses: [
                            { question: "How satisfied are you with remote work tools and technology?", ratings: [1,2,8,20,12], totalResponses: 43, averageRating: 3.9 },
                            { question: "How satisfied are you with communication and collaboration remotely?", ratings: [2,5,12,18,6], totalResponses: 43, averageRating: 3.5 },
                            { question: "How satisfied are you with remote work productivity levels?", ratings: [0,3,6,25,9], totalResponses: 43, averageRating: 3.9 },
                            { question: "How satisfied are you with manager support during remote work?", ratings: [1,4,10,22,6], totalResponses: 43, averageRating: 3.7 }
                        ],
                        totalResponses: 43,
                        status: 'active'
                    },
                    {
                        id: 3,
                        title: "Workplace Diversity & Inclusion Survey",
                        description: "Assessment of diversity, equity, and inclusion initiatives within the organization and their effectiveness in creating an inclusive workplace.",
                        questions: [
                            "How satisfied are you with diversity and inclusion efforts?",
                            "How satisfied are you with equal opportunities for advancement?",
                            "How satisfied are you with respect and fairness in the workplace?",
                            "How satisfied are you with leadership commitment to D&I?"
                        ],
                        creator: "0x1234567890123456789012345678901234567890", // HR Admin address
                        createdAt: new Date('2025-03-01'),
                        endTime: new Date('2026-12-31'),
                        responses: [
                            { question: "How satisfied are you with diversity and inclusion efforts?", ratings: [3,6,15,18,5], totalResponses: 47, averageRating: 3.4 },
                            { question: "How satisfied are you with equal opportunities for advancement?", ratings: [4,8,16,15,4], totalResponses: 47, averageRating: 3.1 },
                            { question: "How satisfied are you with respect and fairness in the workplace?", ratings: [2,4,12,22,7], totalResponses: 47, averageRating: 3.6 },
                            { question: "How satisfied are you with leadership commitment to D&I?", ratings: [5,7,14,16,5], totalResponses: 47, averageRating: 3.2 }
                        ],
                        totalResponses: 47,
                        status: 'active'
                    }
                ];
                
                surveys = presetSurveys;
                saveSurveys();
                console.log('üìã Preset surveys initialized:', surveys.length);
            }
        }

        // Ê∏ÖÈô§ÊóßÊï∞ÊçÆÂπ∂ÈáçÊñ∞ÂàùÂßãÂåñ
        function clearAndResetData() {
            console.log('üßπ Clearing old survey data...');
            localStorage.removeItem('employeeSurvey_surveys');
            localStorage.removeItem('employeeSurvey_responses');
            surveys = [];
            userResponses = {};
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Employee Survey System initializing...');
            
            // Ê∏ÖÈô§ÊóßÊï∞ÊçÆ‰ª•Á°Æ‰øù‰ΩøÁî®ÊúÄÊñ∞ÁöÑÈ¢ÑËÆæÊï∞ÊçÆ
            clearAndResetData();
            
            initializePresetSurveys();
            renderSurveys();
            checkWalletConnection();
            showAlert('‚ú® Employee Survey System launched successfully', 'success', 3000);
        });

        // Ê£ÄÊü•Èí±ÂåÖËøûÊé•
        async function checkWalletConnection() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    // Ê∑ªÂä†Ë∂ÖÊó∂Â§ÑÁêÜÔºåÈÅøÂÖçÈïøÊó∂Èó¥Á≠âÂæÖ
                    const timeout = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Connection timeout')), 3000)
                    );
                    
                    const accountsPromise = window.ethereum.request({ method: 'eth_accounts' });
                    const accounts = await Promise.race([accountsPromise, timeout]);
                    
                    if (accounts.length > 0) {
                        account = accounts[0];
                        
                        // ÂàùÂßãÂåñWeb3ÂíåÂêàÁ∫¶
                        await initializeWeb3();
                        
                        await updateBalance();
                        updateWalletDisplay();
                        renderSurveys();
                        showAlert('üéâ Wallet connected automatically', 'success', 3000);
                        console.log('‚úÖ Wallet auto-connected:', account);
                    }
                } catch (error) {
                    // Âè™ËÆ∞ÂΩïÁúüÊ≠£ÁöÑÈîôËØØÔºåÂøΩÁï•Êâ©Â±ïÁõ∏ÂÖ≥ÁöÑË≠¶Âëä
                    if (!error.message.includes('runtime.lastError') && 
                        !error.message.includes('Connection timeout')) {
                        console.error('Failed to check wallet connection:', error);
                    }
                }
            } else {
                console.log('üí° MetaMask not installed');
            }
        }

        // ËøûÊé•Èí±ÂåÖÂπ∂ÂàáÊç¢Âà∞ Sepolia ÁΩëÁªú
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showAlert('‚ùå Please install MetaMask wallet extension first', 'error');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            const btn = document.getElementById('connect-btn');
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                console.log('üîó Connecting wallet...');
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                if (accounts.length > 0) {
                    account = accounts[0];
                    
                    // Ê£ÄÊü•Âπ∂ÂàáÊç¢Âà∞ Sepolia ÁΩëÁªú
                    await ensureSepoliaNetwork();
                    
                    // ÂàùÂßãÂåñWeb3ÂíåÂêàÁ∫¶
                    await initializeWeb3();
                    
                    await updateBalance();
                    updateWalletDisplay();
                    renderSurveys();
                    showAlert('üéâ Wallet connected to Sepolia testnet!', 'success');
                    console.log('‚úÖ Wallet connected successfully:', account);
                }
            } catch (error) {
                console.error('Wallet connection failed:', error);
                if (error.code === 4001) {
                    showAlert('‚ö†Ô∏è User rejected wallet connection', 'warning');
                } else if (error.code === -32002) {
                    showAlert('‚è≥ Wallet connection request pending, please confirm in wallet', 'warning');
                } else {
                    showAlert('‚ùå Wallet connection failed', 'error');
                }
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // Á°Æ‰øùËøûÊé•Âà∞ Sepolia ÁΩëÁªú
        async function ensureSepoliaNetwork() {
            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                if (chainId !== SEPOLIA_CHAIN_ID) {
                    console.log('üîÑ Switching to Sepolia network...');
                    
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: SEPOLIA_CHAIN_ID }],
                        });
                        showAlert('‚úÖ Switched to Sepolia testnet', 'success');
                    } catch (switchError) {
                        // Â¶ÇÊûúÁΩëÁªú‰∏çÂ≠òÂú®ÔºåÊ∑ªÂä† Sepolia ÁΩëÁªú
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: SEPOLIA_CHAIN_ID,
                                    chainName: 'Sepolia Test Network',
                                    nativeCurrency: {
                                        name: 'Sepolia ETH',
                                        symbol: 'SEP ETH',
                                        decimals: 18
                                    },
                                    rpcUrls: ['https://sepolia.infura.io/v3/', 'https://rpc.sepolia.org/'],
                                    blockExplorerUrls: ['https://sepolia.etherscan.io/']
                                }]
                            });
                            showAlert('‚úÖ Added and switched to Sepolia testnet', 'success');
                        } else {
                            throw switchError;
                        }
                    }
                } else {
                    console.log('‚úÖ Already on Sepolia network');
                }
            } catch (error) {
                console.error('Network switch failed:', error);
                showAlert('‚ö†Ô∏è Please manually switch to Sepolia testnet in MetaMask', 'warning');
                throw error;
            }
        }

        // ÂàùÂßãÂåñWeb3ÂíåÂêàÁ∫¶
        async function initializeWeb3() {
            try {
                if (typeof window.ethereum !== 'undefined' && typeof Web3 !== 'undefined') {
                    web3 = new Web3(window.ethereum);
                    contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                    console.log('üîó Web3 and contract initialized successfully');
                    console.log('üìÑ Contract address:', CONTRACT_ADDRESS);
                    
                    // Ê£ÄÊü•ÂêàÁ∫¶Áä∂ÊÄÅÂπ∂Êõ¥Êñ∞UI
                    updateContractStatus();
                    
                    // ÂàùÂßãÂåñÂå∫ÂùóÈìæ‰∏äÁöÑÈ¢ÑËÆæË∞ÉÊü•ÔºàÂ¶ÇÊûúÂ∑≤ËøûÊé•Èí±ÂåÖÔºâ
                    if (account) {
                        await initializeBlockchainSurveys();
                    }
                    
                    return true;
                } else {
                    console.error('Web3 or Ethereum not available');
                    updateContractStatus(false, 'Web3 not available');
                    if (typeof Web3 === 'undefined') {
                        showAlert('‚ö†Ô∏è Web3 library not loaded. Please refresh the page.', 'warning');
                    }
                    return false;
                }
            } catch (error) {
                console.error('Failed to initialize Web3:', error);
                updateContractStatus(false, 'Web3 initialization failed');
                showAlert('‚ö†Ô∏è Failed to initialize blockchain connection', 'warning');
                return false;
            }
        }

        // Âú®Âå∫ÂùóÈìæ‰∏äÂàõÂª∫È¢ÑËÆæË∞ÉÊü•ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®ÁöÑËØùÔºâ
        async function initializeBlockchainSurveys() {
            try {
                if (!account || !contract) return;
                
                console.log('üîç Checking existing blockchain surveys...');
                
                // Ëé∑ÂèñÂå∫ÂùóÈìæ‰∏äÁöÑË∞ÉÊü•ÊÄªÊï∞
                const totalSurveys = await contract.methods.getTotalSurveys().call();
                console.log('üìä Total surveys on blockchain:', totalSurveys);
                
                // Â¶ÇÊûúÂå∫ÂùóÈìæ‰∏äÊ≤°ÊúâË∞ÉÊü•ÔºåÂàõÂª∫È¢ÑËÆæË∞ÉÊü•
                if (totalSurveys === '0') {
                    console.log('üìù Creating preset surveys on blockchain...');
                    showAlert('üîÑ Initializing employee surveys on blockchain...', 'info');
                    
                    const presetSurveys = [
                        {
                            title: "Q1 2025 Employee Satisfaction Survey",
                            description: "Quarterly assessment of employee satisfaction across all departments focusing on work environment, management, and career development opportunities.",
                            questions: [
                                "How satisfied are you with the overall work environment?",
                                "How satisfied are you with your direct supervisor's management style?",
                                "How satisfied are you with the compensation and benefits package?",
                                "How satisfied are you with career development opportunities?",
                                "How satisfied are you with work-life balance?"
                            ],
                            duration: 365 // 1 year
                        },
                        {
                            title: "Remote Work Experience Survey",
                            description: "Evaluate employee experience with remote work policies, tools, and collaboration effectiveness in distributed teams.",
                            questions: [
                                "How satisfied are you with remote work tools and technology?",
                                "How satisfied are you with communication and collaboration remotely?",
                                "How satisfied are you with remote work productivity levels?",
                                "How satisfied are you with manager support during remote work?"
                            ],
                            duration: 365 // 1 year
                        },
                        {
                            title: "Workplace Diversity & Inclusion Survey",
                            description: "Assessment of diversity, equity, and inclusion initiatives within the organization and their effectiveness in creating an inclusive workplace.",
                            questions: [
                                "How satisfied are you with diversity and inclusion efforts?",
                                "How satisfied are you with equal opportunities for advancement?",
                                "How satisfied are you with respect and fairness in the workplace?",
                                "How satisfied are you with leadership commitment to D&I?"
                            ],
                            duration: 365 // 1 year
                        }
                    ];
                    
                    // ÂàõÂª∫ÊØè‰∏™È¢ÑËÆæË∞ÉÊü•
                    for (let i = 0; i < presetSurveys.length; i++) {
                        const survey = presetSurveys[i];
                        try {
                            console.log(`üìù Creating survey ${i + 1}:`, survey.title);
                            
                            const gasEstimate = await contract.methods
                                .createSurvey(survey.title, survey.description, survey.questions, survey.duration)
                                .estimateGas({ from: account });
                                
                            const tx = await contract.methods
                                .createSurvey(survey.title, survey.description, survey.questions, survey.duration)
                                .send({ 
                                    from: account,
                                    gas: Math.floor(gasEstimate * 1.2),
                                    gasPrice: await web3.eth.getGasPrice()
                                });
                                
                            console.log(`‚úÖ Survey ${i + 1} created:`, tx.transactionHash);
                            
                        } catch (error) {
                            console.error(`‚ùå Failed to create survey ${i + 1}:`, error);
                            // Â¶ÇÊûúÂàõÂª∫Â§±Ë¥•ÔºåÁªßÁª≠Â∞ùËØï‰∏ã‰∏Ä‰∏™
                            continue;
                        }
                    }
                    
                    showAlert('‚úÖ Employee surveys initialized on blockchain!', 'success');
                    
                    // ÈáçÊñ∞Âä†ËΩΩË∞ÉÊü•ÂàóË°®
                    await loadSurveysFromBlockchain();
                    
                } else {
                    console.log('‚úÖ Surveys already exist on blockchain');
                    // ‰ªéÂå∫ÂùóÈìæÂä†ËΩΩÁé∞ÊúâË∞ÉÊü•
                    await loadSurveysFromBlockchain();
                }
                
            } catch (error) {
                console.error('‚ùå Failed to initialize blockchain surveys:', error);
                showAlert('‚ö†Ô∏è Using preset surveys in local mode', 'warning');
            }
        }

        // ‰ªéÂå∫ÂùóÈìæÂä†ËΩΩË∞ÉÊü•
        async function loadSurveysFromBlockchain() {
            try {
                if (!contract) return;
                
                console.log('üì• Loading surveys from blockchain...');
                const totalSurveys = await contract.methods.getTotalSurveys().call();
                console.log('üìä Found', totalSurveys, 'surveys on blockchain');
                
                const blockchainSurveys = [];
                
                for (let i = 1; i <= totalSurveys; i++) {
                    try {
                        const surveyData = await contract.methods.getSurvey(i).call();
                        const questions = await contract.methods.getSurveyQuestions(i).call();
                        
                        const survey = {
                            id: i,
                            title: surveyData[1],
                            description: surveyData[2],
                            questions: questions,
                            creator: surveyData[0],
                            createdAt: new Date(surveyData[3] * 1000),
                            endTime: new Date(surveyData[4] * 1000),
                            status: surveyData[5] ? 'active' : 'inactive',
                            totalResponses: parseInt(surveyData[7]),
                            responses: questions.map(() => ({
                                ratings: [0,0,0,0,0],
                                totalResponses: 0,
                                averageRating: 0
                            }))
                        };
                        
                        blockchainSurveys.push(survey);
                        console.log(`üìã Loaded survey ${i}:`, survey.title);
                        
                    } catch (error) {
                        console.error(`‚ùå Failed to load survey ${i}:`, error);
                    }
                }
                
                if (blockchainSurveys.length > 0) {
                    surveys = blockchainSurveys;
                    saveSurveys();
                    renderSurveys();
                    console.log('‚úÖ Surveys loaded from blockchain:', surveys.length);
                }
                
            } catch (error) {
                console.error('‚ùå Failed to load surveys from blockchain:', error);
            }
        }

        // Êõ¥Êñ∞ÂêàÁ∫¶Áä∂ÊÄÅÊòæÁ§∫
        async function updateContractStatus(forceStatus = null, message = null) {
            const statusElement = document.getElementById('contract-status');
            
            if (!statusElement) return;
            
            // Ê£ÄÊü•FHEÂêàÁ∫¶ÊòØÂê¶Â≠òÂú®
            const contractExists = await checkContractExists();
            
            if (contractExists) {
                statusElement.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite;"></span>
                        <span>FHE Contract Active - Encrypted Survey System</span>
                    </div>
                `;
            } else {
                statusElement.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="width: 8px; height: 8px; background: orange; border-radius: 50%; animation: pulse 2s infinite;"></span>
                        <span>Local Fallback Mode - Contract Not Detected</span>
                    </div>
                `;
            }
            return;
            
            if (forceStatus === false) {
                statusElement.innerHTML = '‚ùå Contract Unavailable - Local Mode';
                statusElement.style.background = 'rgba(239, 68, 68, 0.2)';
                statusElement.style.borderColor = '#ef4444';
                return;
            }
            
            if (!web3) {
                statusElement.innerHTML = '‚è≥ Waiting for wallet connection...';
                statusElement.style.background = 'rgba(251, 146, 60, 0.2)';
                return;
            }
            
            try {
                const contractExists = await checkContractExists();
                if (contractExists) {
                    statusElement.innerHTML = '‚úÖ Contract Active - Blockchain Mode';
                    statusElement.style.background = 'rgba(16, 185, 129, 0.2)';
                    statusElement.style.borderColor = '#10b981';
                } else {
                    statusElement.innerHTML = '‚ö†Ô∏è Contract Not Deployed - Local Mode';
                    statusElement.style.background = 'rgba(251, 146, 60, 0.2)';
                    statusElement.style.borderColor = '#f59e0b';
                }
            } catch (error) {
                statusElement.innerHTML = '‚ùå Contract Check Failed - Local Mode';
                statusElement.style.background = 'rgba(239, 68, 68, 0.2)';
                statusElement.style.borderColor = '#ef4444';
            }
        }

        // Êñ≠ÂºÄÈí±ÂåÖ
        function disconnectWallet() {
            account = null;
            balance = '0.0000';
            updateWalletDisplay();
            renderSurveys();
            showAlert('üëã Wallet disconnected', 'info');
            console.log('üîå Wallet disconnected');
        }

        // Êõ¥Êñ∞‰ΩôÈ¢ù
        async function updateBalance() {
            if (!account) return;
            
            try {
                const balanceWei = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [account, 'latest']
                });
                balance = (parseInt(balanceWei, 16) / Math.pow(10, 18)).toFixed(4);
                console.log('üí∞ Balance updated:', balance, 'ETH');
            } catch (error) {
                console.error('Failed to get balance:', error);
            }
        }

        // Êõ¥Êñ∞Èí±ÂåÖÊòæÁ§∫
        function updateWalletDisplay() {
            const status = document.getElementById('wallet-status');
            const details = document.getElementById('wallet-details');
            const btn = document.getElementById('connect-btn');

            if (account) {
                status.className = 'status connected';
                status.textContent = 'Wallet Connected';
                
                document.getElementById('wallet-address').textContent = 
                    `Address: ${account.substring(0, 8)}...${account.substring(34)}`;
                document.getElementById('wallet-balance').textContent = 
                    `Balance: ${balance} ETH`;
                
                details.style.display = 'block';
                btn.textContent = 'üîì Disconnect';
                btn.onclick = disconnectWallet;
            } else {
                status.className = 'status disconnected';
                status.textContent = 'Wallet Disconnected';
                details.style.display = 'none';
                btn.textContent = 'üîó Connect Wallet';
                btn.onclick = connectWallet;
            }
        }

        // ÊòæÁ§∫ÈÉ®ÂàÜ
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`${section}-section`).classList.remove('hidden');
            event.target.classList.add('active');
            
            console.log('üîÑ Switched to section:', section);
        }

        // ÂàõÂª∫Ë∞ÉÊü•
        async function createSurvey(event) {
            event.preventDefault();
            
            if (!account) {
                showAlert('‚ùå Please connect wallet first', 'error');
                return;
            }

            const title = document.getElementById('survey-title').value.trim();
            const description = document.getElementById('survey-description').value.trim();
            const duration = parseInt(document.getElementById('survey-duration').value);
            
            // Ëé∑ÂèñË∞ÉÊü•ÈóÆÈ¢ò
            const questionInputs = document.querySelectorAll('#survey-questions input');
            const questions = Array.from(questionInputs).map(input => input.value.trim()).filter(q => q);

            if (!title || !description || !duration || duration < 1 || questions.length < 1) {
                showAlert('‚ùå Please fill all required fields and provide at least 1 survey question', 'error');
                return;
            }

            try {
                console.log('üìù Creating survey on blockchain:', {title, description, duration, questions});
                
                // È™åËØÅÂêàÁ∫¶ËøûÊé•
                if (!web3 || !contract) {
                    showAlert('üì° Initializing FHE contract connection...', 'info');
                    const initialized = await initializeWeb3();
                    if (!initialized) {
                        throw new Error('Failed to initialize Web3');
                    }
                }

                showAlert('üîÑ Creating survey on FHE blockchain...', 'info');
                console.log('üìä Calling createSurvey on contract:', CONTRACT_ADDRESS);
                
                // ÂÆûÈôÖÁöÑÂå∫ÂùóÈìæ‰∫§ÊòìÂàõÂª∫Ë∞ÉÊü•
                const gasEstimate = await contract.methods
                    .createSurvey(title, description, questions, duration)
                    .estimateGas({ from: account });
                    
                console.log('‚õΩ Estimated gas for survey creation:', gasEstimate);
                
                const tx = await contract.methods
                    .createSurvey(title, description, questions, duration)
                    .send({ 
                        from: account,
                        gas: Math.floor(gasEstimate * 1.2),
                        gasPrice: await web3.eth.getGasPrice()
                    });

                showAlert('‚è≥ Survey creation transaction sent! Waiting for confirmation...', 'info');
                console.log('üì§ Survey creation transaction:', tx.transactionHash);
                
                // Á≠âÂæÖ‰∫§ÊòìÁ°ÆËÆ§
                let receipt;
                let attempts = 0;
                const maxAttempts = 30;
                
                while (attempts < maxAttempts) {
                    receipt = await web3.eth.getTransactionReceipt(tx.transactionHash);
                    if (receipt) break;
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    attempts++;
                    
                    if (attempts % 5 === 0) {
                        showAlert(`‚è≥ Still waiting for confirmation... (${attempts}s)`, 'info');
                    }
                }
                
                if (!receipt || !receipt.status) {
                    throw new Error('Survey creation transaction failed');
                }
                
                showAlert(`üéâ Survey Created on Blockchain! TX: ${tx.transactionHash.substring(0, 12)}...`, 'success');
                console.log('‚úÖ Survey creation confirmed on blockchain:', tx.transactionHash);
                
                // Ëé∑ÂèñÂàõÂª∫ÁöÑË∞ÉÊü•ID
                const totalSurveys = await contract.methods.getTotalSurveys().call();
                const surveyId = totalSurveys;
                
                console.log('üìã Survey ID from blockchain:', surveyId);
                
                // ÂàõÂª∫Êú¨Âú∞ÂâØÊú¨Áî®‰∫éUIÊòæÁ§∫
                const survey = {
                    id: parseInt(surveyId),
                    title,
                    description,
                    questions,
                    creator: account,
                    createdAt: new Date(),
                    endTime: new Date(Date.now() + duration * 24 * 60 * 60 * 1000),
                    responses: questions.map(question => ({
                        question, 
                        ratings: [0,0,0,0,0],
                        totalResponses: 0,
                        averageRating: 0
                    })),
                    totalResponses: 0,
                    status: 'active',
                    onChain: true,
                    txHash: tx.transactionHash,
                    blockNumber: receipt.blockNumber,
                    gasUsed: receipt.gasUsed
                };

                surveys.push(survey);
                saveSurveys();
                renderSurveys();
                
                document.getElementById('create-form').reset();
                showSection('surveys');
                
                console.log('‚úÖ Survey created successfully on blockchain:', survey);

            } catch (error) {
                console.error('üö´ Blockchain survey creation failed:', error);
                
                let errorMessage = 'Failed to create survey on blockchain';
                if (error.code === 4001) {
                    errorMessage = 'Transaction cancelled by user';
                } else if (error.code === -32000) {
                    errorMessage = 'Insufficient funds for gas';
                } else if (error.message?.includes('execution reverted')) {
                    errorMessage = 'Contract execution failed - check parameters';
                }
                
                showAlert(`‚ùå ${errorMessage}`, 'error');
                
                // ‰Ωú‰∏∫fallbackÂàõÂª∫Êú¨Âú∞Ë∞ÉÊü•
                console.log('üì¶ Creating local survey as fallback...');
                
                const localSurvey = {
                    id: Date.now(),
                    title,
                    description,
                    questions,
                    creator: account,
                    createdAt: new Date(),
                    endTime: new Date(Date.now() + duration * 24 * 60 * 60 * 1000),
                    responses: questions.map(question => ({
                        question, 
                        ratings: [0,0,0,0,0],
                        totalResponses: 0,
                        averageRating: 0
                    })),
                    totalResponses: 0,
                    status: 'active',
                    onChain: false
                };

                surveys.push(localSurvey);
                saveSurveys();
                renderSurveys();
                
                document.getElementById('create-form').reset();
                showAlert('üì¶ Created local survey as fallback', 'warning');
                showSection('surveys');
            }
        }

        // Ê£ÄÊü•ÂêàÁ∫¶ÊòØÂê¶Âú®Âå∫ÂùóÈìæ‰∏äÂ≠òÂú®
        async function checkContractExists() {
            try {
                if (!web3) return false;
                
                const code = await web3.eth.getCode(CONTRACT_ADDRESS);
                const exists = code && code !== '0x' && code !== '0x0';
                console.log('üîç Contract exists:', exists, 'Code length:', code ? code.length : 0);
                return exists;
            } catch (error) {
                console.error('Failed to check contract existence:', error);
                return false;
            }
        }

        // Êèê‰∫§ÂÆåÊï¥Ë∞ÉÊü•ÂìçÂ∫îÔºàÂå∫ÂùóÈìæ‰∫§ÊòìÊàñÊú¨Âú∞Â≠òÂÇ®Ôºâ
        async function submitSurveyResponse(surveyId) {
            console.log('üìä Starting survey submission:', {surveyId});
            
            if (!account) {
                showAlert('‚ùå Please connect wallet first', 'error');
                return;
            }
            
            if (!web3 || !contract) {
                showAlert('üì° Initializing blockchain connection...', 'info');
                const initialized = await initializeWeb3();
                if (!initialized) {
                    showAlert('‚ö†Ô∏è Blockchain unavailable, using local storage mode', 'warning');
                    return await submitLocalResponse(surveyId);
                }
            }

            // Áõ¥Êé•Â∞ùËØïFHEÂå∫ÂùóÈìæ‰∫§‰∫í
            console.log('üîó Starting FHE survey submission process...');
            
            // Ëé∑ÂèñsurveyÂØπË±°
            const survey = surveys.find(s => s.id === surveyId);
            if (!survey) {
                showAlert('‚ùå Survey not found', 'error');
                return;
            }
            
            try {
                // Êî∂ÈõÜÊâÄÊúâÈóÆÈ¢òÁöÑËØÑÂàÜ
                const answers = [];
                for (let i = 0; i < survey.questions.length; i++) {
                    const rating = document.querySelector(`input[name="survey-${surveyId}-question-${i}"]:checked`);
                    if (!rating) {
                        showAlert(`‚ùå Please rate question ${i + 1} before submitting`, 'error');
                        return;
                    }
                    answers.push(parseInt(rating.value));
                }
                
                // È™åËØÅÂêàÁ∫¶ËøûÊé•
                if (!web3 || !contract) {
                    showAlert('üì° Initializing FHE contract connection...', 'info');
                    const initialized = await initializeWeb3();
                    if (!initialized) {
                        throw new Error('Failed to initialize Web3');
                    }
                }
                
                // Êèê‰∫§Âà∞FHEÂêàÁ∫¶ - ÂÆûÈôÖÂå∫ÂùóÈìæ‰∫§‰∫í
                showAlert('üîê Encrypting and submitting survey responses...', 'info');
                console.log('üìä Submitting to FHE contract:', CONTRACT_ADDRESS);
                console.log('üìù Survey answers:', answers);
                
                // ÂÆûÈôÖÁöÑÂå∫ÂùóÈìæ‰∫§Êòì
                const gasEstimate = await contract.methods
                    .submitResponse(surveyId, answers)
                    .estimateGas({ from: account });
                    
                console.log('‚õΩ Estimated gas:', gasEstimate);
                
                const tx = await contract.methods
                    .submitResponse(surveyId, answers)
                    .send({ 
                        from: account,
                        gas: Math.floor(gasEstimate * 1.2), // Â¢ûÂä†20%gas buffer
                        gasPrice: await web3.eth.getGasPrice()
                    });
                
                showAlert('‚è≥ FHE transaction sent! Waiting for blockchain confirmation...', 'info');
                console.log('üì§ Transaction sent:', tx.transactionHash);
                
                // Á≠âÂæÖ‰∫§ÊòìÁ°ÆËÆ§
                let receipt;
                let attempts = 0;
                const maxAttempts = 30; // ÊúÄÂ§öÁ≠âÂæÖ30Áßí
                
                while (attempts < maxAttempts) {
                    receipt = await web3.eth.getTransactionReceipt(tx.transactionHash);
                    if (receipt) break;
                    
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Á≠âÂæÖ1Áßí
                    attempts++;
                    
                    if (attempts % 5 === 0) {
                        showAlert(`‚è≥ Still waiting for confirmation... (${attempts}s)`, 'info');
                    }
                }
                
                if (!receipt) {
                    throw new Error('Transaction confirmation timeout');
                }
                
                if (receipt.status) {
                    showAlert(`üéâ FHE Survey Successfully Submitted! TX: ${tx.transactionHash.substring(0, 12)}...`, 'success');
                    console.log('‚úÖ FHE transaction confirmed:', tx.transactionHash);
                    console.log('üìã Gas used:', receipt.gasUsed);
                    
                    // ËÆ∞ÂΩïÊàêÂäüÁöÑÂå∫ÂùóÈìæÊèê‰∫§
                    const userKey = `${account}_${surveyId}`;
                    userResponses[userKey] = {
                        surveyId,
                        timestamp: new Date().toISOString(),
                        txHash: tx.transactionHash,
                        answers: answers,
                        method: 'fhe_blockchain',
                        gasUsed: receipt.gasUsed,
                        blockNumber: receipt.blockNumber
                    };
                    localStorage.setItem('employeeSurvey_responses', JSON.stringify(userResponses));
                    
                    // Êõ¥Êñ∞UIÁä∂ÊÄÅ
                    const submitBtn = surveyElement.querySelector('.submit-survey-btn');
                    if (submitBtn) {
                        submitBtn.innerHTML = '‚úÖ Submitted to Blockchain';
                        submitBtn.disabled = true;
                        submitBtn.style.opacity = '0.6';
                    }
                    
                    return;
                } else {
                    throw new Error('Transaction failed - receipt status false');
                }
                
            } catch (error) {
                console.error('üö´ FHE submission failed:', error);
                
                let errorMessage = 'FHE contract interaction failed';
                if (error.code === 4001) {
                    errorMessage = 'Transaction cancelled by user';
                } else if (error.code === -32000) {
                    errorMessage = 'Insufficient funds for gas';
                } else if (error.message?.includes('execution reverted')) {
                    errorMessage = 'Contract execution failed - check survey status';
                } else if (error.message?.includes('timeout')) {
                    errorMessage = 'Transaction timeout - may still be processing';
                }
                
                showAlert(`‚ö†Ô∏è ${errorMessage}. Using local mode.`, 'warning');
            }
            
            // ÂõûÈÄÄÂà∞Êú¨Âú∞Â≠òÂÇ®Ê®°Âºè
            showAlert('üì¶ Using local mode - Deploy EmployeePrivacyFHE.sol contract', 'info');
            return await submitLocalResponse(surveyId);

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂèÇ‰∏éËøáË∞ÉÊü•
            const userKey = `${account}_${surveyId}`;
            if (userResponses[userKey]) {
                showAlert('‚ö†Ô∏è You have already participated in this survey', 'warning');
                return;
            }

            // Êî∂ÈõÜÊâÄÊúâÈóÆÈ¢òÁöÑËØÑÂàÜ
            const answers = [];
            for (let i = 0; i < survey.questions.length; i++) {
                const rating = document.querySelector(`input[name="survey-${surveyId}-question-${i}"]:checked`);
                if (!rating) {
                    showAlert(`‚ùå Please rate question ${i + 1} before submitting`, 'error');
                    return;
                }
                answers.push(parseInt(rating.value));
            }

            try {
                showAlert('üìä Submitting survey response to blockchain...', 'info');
                
                // ÂàõÂª∫Âä†ÂØÜÁöÑÁ≠îÊ°àÊï∞ÁªÑÔºàÁÆÄÂåñÁâàÔºåÂÆûÈôÖÂ∫î‰ΩøÁî®FHEÂä†ÂØÜÔºâ
                const encryptedAnswers = answers.map(answer => {
                    // Ê®°ÊãüÂä†ÂØÜÔºåÂÆûÈôÖÂ∫î‰ΩøÁî®TFHE.encrypt()
                    return web3.utils.asciiToHex(answer.toString());
                });

                // Ë∞ÉÁî®ÂêàÁ∫¶Êèê‰∫§ÂìçÂ∫î
                console.log('üîç Estimating gas for transaction...');
                console.log('Contract method exists:', !!contract.methods.submitResponse);
                
                const gasEstimate = await contract.methods
                    .submitResponse(surveyId, encryptedAnswers)
                    .estimateGas({ from: account });
                
                console.log('‚õΩ Estimated gas:', gasEstimate);

                const tx = await contract.methods
                    .submitResponse(surveyId, encryptedAnswers)
                    .send({ 
                        from: account,
                        gas: Math.floor(gasEstimate * 1.2)
                    });
                
                console.log('‚úÖ Transaction sent:', tx);

                console.log('‚úÖ Transaction successful:', tx.transactionHash);

                // Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
                for (let i = 0; i < answers.length; i++) {
                    survey.responses[i].ratings[answers[i] - 1]++;
                    survey.responses[i].totalResponses++;
                    
                    // ÈáçÊñ∞ËÆ°ÁÆóÂπ≥ÂùáÂàÜ
                    let totalScore = 0;
                    for (let j = 0; j < 5; j++) {
                        totalScore += survey.responses[i].ratings[j] * (j + 1);
                    }
                    survey.responses[i].averageRating = 
                        (totalScore / survey.responses[i].totalResponses).toFixed(1);
                }

                // ËÆ∞ÂΩïÁî®Êà∑ÂèÇ‰∏é
                userResponses[userKey] = {
                    surveyId,
                    timestamp: new Date(),
                    txHash: tx.transactionHash,
                    answers: answers
                };

                saveSurveys();
                saveUserResponses();
                renderSurveys();
                
                showAlert(`üéâ Survey response submitted successfully! TX: ${tx.transactionHash.substring(0, 10)}...`, 'success');
                
                // ÊòæÁ§∫EtherscanÈìæÊé•
                setTimeout(() => {
                    showAlert(`üîç View transaction: https://sepolia.etherscan.io/tx/${tx.transactionHash}`, 'info', 10000);
                }, 1000);

            } catch (error) {
                console.error('Survey submission failed:', error);
                let errorMsg = 'Survey submission failed';
                
                if (error.code === 4001) {
                    errorMsg = 'Transaction cancelled by user';
                } else if (error.message.includes('revert')) {
                    errorMsg = 'Contract rejected transaction - you may have already responded';
                } else if (error.message.includes('insufficient funds')) {
                    errorMsg = 'Insufficient ETH for gas fees';
                }
                
                showAlert(`‚ùå ${errorMsg}`, 'error');
            }
        }

        // Êú¨Âú∞Â≠òÂÇ®fallbackÊ®°ÂºèÔºàÂΩìÂêàÁ∫¶‰∏çÂèØÁî®Êó∂Ôºâ
        async function submitLocalResponse(surveyId) {
            console.log('üíæ Submitting survey response locally:', {surveyId});
            
            const survey = surveys.find(s => s.id === surveyId);
            if (!survey) {
                showAlert('‚ùå Survey does not exist', 'error');
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂèÇ‰∏éËøáË∞ÉÊü•
            const userKey = `${account}_${surveyId}`;
            if (userResponses[userKey]) {
                showAlert('‚ö†Ô∏è You have already participated in this survey', 'warning');
                return;
            }

            // Êî∂ÈõÜÊâÄÊúâÈóÆÈ¢òÁöÑËØÑÂàÜ
            const answers = [];
            for (let i = 0; i < survey.questions.length; i++) {
                const rating = document.querySelector(`input[name="survey-${surveyId}-question-${i}"]:checked`);
                if (!rating) {
                    showAlert(`‚ùå Please rate question ${i + 1} before submitting`, 'error');
                    return;
                }
                answers.push(parseInt(rating.value));
            }

            try {
                showAlert('üíæ Saving your responses locally...', 'info');
                
                // Ê®°ÊãüÂ§ÑÁêÜÂª∂Ëøü
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
                for (let i = 0; i < answers.length; i++) {
                    survey.responses[i].ratings[answers[i] - 1]++;
                    survey.responses[i].totalResponses++;
                    
                    // ÈáçÊñ∞ËÆ°ÁÆóÂπ≥ÂùáÂàÜ
                    let totalScore = 0;
                    for (let j = 0; j < 5; j++) {
                        totalScore += survey.responses[i].ratings[j] * (j + 1);
                    }
                    survey.responses[i].averageRating = 
                        (totalScore / survey.responses[i].totalResponses).toFixed(1);
                }

                // ËÆ∞ÂΩïÁî®Êà∑ÂèÇ‰∏éÔºàÊú¨Âú∞Ê®°ÂºèÔºâ
                userResponses[userKey] = {
                    surveyId,
                    timestamp: new Date(),
                    mode: 'local', // Ê†áËÆ∞‰∏∫Êú¨Âú∞Ê®°Âºè
                    answers: answers
                };

                saveSurveys();
                saveUserResponses();
                renderSurveys();
                
                showAlert('üéâ Survey response saved successfully! (Local Mode)', 'success');
                console.log('üíæ Local response saved successfully');

            } catch (error) {
                console.error('Local survey submission failed:', error);
                showAlert('‚ùå Failed to save response locally', 'error');
            }
        }

        // ‰∏¥Êó∂ËØÑÂàÜÂ≠òÂÇ®ÔºàÂú®Êèê‰∫§ÂâçÔºâ
        function selectRating(surveyId, questionIndex, rating) {
            console.log(`‚≠ê Selected rating ${rating} for question ${questionIndex + 1} in survey ${surveyId}`);
            
            // Êõ¥Êñ∞UIÊòæÁ§∫
            const allBtns = document.querySelectorAll(`.rating-btn[data-survey="${surveyId}"][data-question="${questionIndex}"]`);
            allBtns.forEach(btn => {
                btn.style.background = 'rgba(255,255,255,0.1)';
                btn.style.borderColor = 'rgba(255,255,255,0.3)';
                btn.style.transform = 'none';
                btn.style.boxShadow = 'none';
            });
            
            const selectedBtn = document.querySelector(`.rating-btn[data-survey="${surveyId}"][data-question="${questionIndex}"][data-rating="${rating}"]`);
            if (selectedBtn) {
                selectedBtn.style.background = 'linear-gradient(45deg, #10b981, #34d399)';
                selectedBtn.style.borderColor = '#34d399';
                selectedBtn.style.transform = 'translateY(-2px)';
                selectedBtn.style.boxShadow = '0 5px 15px rgba(16, 185, 129, 0.4)';
            }
            
            // Á°Æ‰øùradio buttonË¢´ÈÄâ‰∏≠
            const radioBtn = document.getElementById(`rate-${surveyId}-${questionIndex}-${rating}`);
            if (radioBtn) {
                radioBtn.checked = true;
            }
        }

        // Ê£ÄÊü•Ë∞ÉÊü•Áä∂ÊÄÅ
        function checkSurveyStatus(survey) {
            const now = new Date();
            const endTime = new Date(survey.endTime);
            
            if (now > endTime && survey.status === 'active') {
                survey.status = 'ended';
                return 'ended';
            }
            return survey.status;
        }

        // Ê∏≤ÊüìË∞ÉÊü•
        function renderSurveys() {
            const surveysList = document.getElementById('surveys-list');
            const noSurveys = document.getElementById('no-surveys');

            if (surveys.length === 0) {
                surveysList.innerHTML = '';
                noSurveys.style.display = 'block';
                return;
            }

            noSurveys.style.display = 'none';
            
            surveysList.innerHTML = surveys.map(survey => {
                const status = checkSurveyStatus(survey);
                const isActive = status === 'active';
                const isCreator = survey.creator === account;
                const userKey = `${account}_${survey.id}`;
                const hasParticipated = userResponses[userKey];
                const canParticipate = account && !isCreator && isActive && !hasParticipated;
                
                // Ë∞ÉËØï‰ø°ÊÅØ
                console.log(`Survey ${survey.id} - Can participate:`, {
                    hasAccount: !!account,
                    isNotCreator: !isCreator,
                    isActive: isActive,
                    hasNotParticipated: !hasParticipated,
                    canParticipate: canParticipate
                });
                
                const endTime = new Date(survey.endTime);
                const timeLeft = endTime - new Date();
                const daysLeft = Math.max(0, Math.ceil(timeLeft / (24 * 60 * 60 * 1000)));
                
                return `
                    <div class="project-card">
                        <div class="project-title">${escapeHtml(survey.title)}</div>
                        <div class="project-description">${escapeHtml(survey.description)}</div>
                        
                        <div class="project-stats">
                            <span><strong>Status: ${isActive ? 'üü¢ Active' : 'üî¥ Ended'}</strong></span>
                            <span>Questions: ${survey.questions.length}</span>
                            <span>${isActive ? `Remaining: ${daysLeft} days` : 'Ended'}</span>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            ${survey.responses.map((response, index) => {
                                const avgRating = response.averageRating || 0;
                                const totalResponses = response.totalResponses || 0;
                                
                                return `
                                    <div class="survey-section" style="margin-bottom: 25px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                        <div style="margin-bottom: 10px;">
                                            <strong>Q${index + 1}: ${escapeHtml(response.question)}</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                            <span>Average Rating: ‚≠ê ${avgRating}/5.0</span>
                                            <span>Responses: ${totalResponses}</span>
                                        </div>
                                        ${canParticipate ? `
                                            <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: center;">
                                                ${[1,2,3,4,5].map(rating => `
                                                    <label style="cursor: pointer; display: flex; flex-direction: column; align-items: center;">
                                                        <input type="radio" 
                                                               id="rate-${survey.id}-${index}-${rating}"
                                                               name="survey-${survey.id}-question-${index}" 
                                                               value="${rating}"
                                                               style="display: none;">
                                                        <span class="rating-btn" 
                                                              data-survey="${survey.id}"
                                                              data-question="${index}"
                                                              data-rating="${rating}"
                                                              style="
                                                                padding: 8px 12px; 
                                                                border: 2px solid rgba(255,255,255,0.3); 
                                                                border-radius: 10px; 
                                                                background: rgba(255,255,255,0.1);
                                                                transition: all 0.3s;
                                                                min-width: 40px;
                                                                text-align: center;
                                                                cursor: pointer;
                                                              " onclick="selectRating(${survey.id}, ${index}, ${rating});">
                                                            ${rating}‚≠ê
                                                        </span>
                                                    </label>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        ${canParticipate ? `
                            <div style="background: linear-gradient(45deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.1)); padding: 20px; border-radius: 15px; margin: 20px 0; border: 2px solid rgba(16, 185, 129, 0.3);">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <h3 style="color: #34d399; margin-bottom: 10px;">üëÜ Rate Each Question Above</h3>
                                    <p style="font-size: 0.9rem; opacity: 0.8;">
                                        Click on the ‚≠ê buttons (1-5 stars) to rate each question, then submit your response
                                    </p>
                                </div>
                                <div style="text-align: center;">
                                    <button class="btn" 
                                            style="font-size: 1.1rem; padding: 15px 30px; background: linear-gradient(45deg, #10b981, #34d399);"
                                            onclick="submitSurveyResponse(${survey.id})">
                                        üìä Submit Survey Response
                                    </button>
                                    <p style="font-size: 0.85rem; opacity: 0.7; margin-top: 8px;">
                                        üîê Will attempt blockchain submission, fallback to local storage if needed
                                    </p>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px;">
                            Creator: ${survey.creator.substring(0, 8)}...${survey.creator.substring(34)}<br>
                            Created: ${new Date(survey.createdAt).toLocaleDateString('en-US')}<br>
                            Deadline: ${endTime.toLocaleDateString('en-US')} ${endTime.toLocaleTimeString('en-US')}
                        </div>
                        
                        ${isCreator ? '<div class="owner-badge">üëë Your Survey</div>' : ''}
                        
                        ${hasParticipated ? `
                            <div class="completed-badge">
                                ‚úÖ Participated 
                                ${hasParticipated.txHash ? 
                                    `- <a href="https://sepolia.etherscan.io/tx/${hasParticipated.txHash}" target="_blank" style="color: white;">TX: ${hasParticipated.txHash.substring(0, 10)}...</a>` : 
                                    hasParticipated.mode === 'local' ? '- Local Mode' : ''
                                }
                            </div>` : ''}
                        
                        ${!account ? 
                            '<div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 15px;">Please connect wallet to participate in survey</div>' 
                            : ''
                        }
                    </div>
                `;
            }).join('');
            
            console.log('üìä Surveys list rendered:', surveys.length, 'surveys');
        }

        // HTMLËΩ¨‰πâ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ÊòæÁ§∫ÊèêÁ§∫Ê∂àÊÅØ
        function showAlert(message, type = 'success', duration = 5000) {
            console.log('üí¨ ÊòæÁ§∫Ê∂àÊÅØ:', type, message);
            
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            alert.innerHTML = `${icons[type] || '‚ÑπÔ∏è'} ${message}`;
            
            alerts.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.parentNode.removeChild(alert);
                        }
                    }, 300);
                }
            }, duration);
        }

        // ‰øùÂ≠òË∞ÉÊü•Âà∞Êú¨Âú∞Â≠òÂÇ®
        function saveSurveys() {
            try {
                localStorage.setItem('employeeSurvey_surveys', JSON.stringify(surveys));
                console.log('üíæ Survey data saved');
            } catch (error) {
                console.error('Failed to save surveys:', error);
                showAlert('‚ö†Ô∏è Failed to save data', 'warning');
            }
        }
        
        // ‰øùÂ≠òÁî®Êà∑ÂìçÂ∫îÂà∞Êú¨Âú∞Â≠òÂÇ®
        function saveUserResponses() {
            try {
                localStorage.setItem('employeeSurvey_responses', JSON.stringify(userResponses));
                console.log('üíæ User response data saved');
            } catch (error) {
                console.error('Failed to save user responses:', error);
                showAlert('‚ö†Ô∏è Failed to save data', 'warning');
            }
        }

        // ÁõëÂê¨Èí±ÂåÖ‰∫ã‰ª∂
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                console.log('üîÑ Account changed:', accounts);
                if (accounts.length === 0) {
                    disconnectWallet();
                } else if (accounts[0] !== account) {
                    account = accounts[0];
                    initializeWeb3().then(() => {
                        updateBalance().then(() => {
                            updateWalletDisplay();
                            renderSurveys();
                            showAlert('üîÑ Account switched', 'info');
                        });
                    });
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                console.log('üîÑ Network changed to:', chainId);
                if (chainId !== SEPOLIA_CHAIN_ID) {
                    showAlert('‚ö†Ô∏è Please switch back to Sepolia testnet', 'warning');
                } else {
                    showAlert('‚úÖ Connected to Sepolia testnet', 'success');
                }
                initializeWeb3().then(() => {
                    updateBalance().then(() => {
                        updateWalletDisplay();
                        renderSurveys();
                    });
                });
            });
        }

        // È°µÈù¢Âç∏ËΩΩÂâçÊ∏ÖÁêÜ
        window.addEventListener('beforeunload', () => {
            // Ê∏ÖÁêÜÊâÄÊúâË∂ÖÊó∂Âô®
            surveyTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
            surveyTimeouts.clear();
            surveyStates.clear();
            console.log('üßπ Application cleanup completed');
        });
    </script>
</body>
</html>